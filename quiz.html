<!doctype html><html lang="zh-Hant"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>測驗</title><link rel="stylesheet" href="styles.css"></head><body><header class="header container"><h1 id="page-title">本章測驗</h1>
  <div style=\"position:absolute;right:16px;top:14px;\"><button class=\"btn small ghost\" onclick=\"location.href='home.html'\">← 返回主選單</button></div></header><main class="container"><div id="quiz-area" class="card-center"><div id="meta" style="text-align:left;margin-bottom:8px;color:var(--muted)"></div><div id="qbox" style="font-size:20px;margin-bottom:12px">按下開始以產生題庫</div><div id="choices"></div><div class="status" id="status"></div><div style="margin-top:12px" id="controls"><button id="start" class="btn">開始測驗</button> <button id="end" class="btn ghost hidden">結束測驗</button></div></div><div id="result" style="margin-top:18px"></div></main><script src="data.js"></script><script src="app-common.js"></script><script>const unit=qsParam('u')||'unit1';document.getElementById('page-title').textContent=unit.toUpperCase()+' — 本章測驗';const list=vocabByUnit[unit]||[];let poolA=[],poolB=[],quiz=[],pos=0,correct=0,timer=0,tid=null;function buildPools(){
  // default pools: A and B from list
  poolA = list.map((it,i)=>({id:(i+1)+'A',type:'A',prompt:it.word,answer:it.definition}));
  poolB = list.map((it,i)=>({id:(i+1)+'B',type:'B',prompt:it.definition,answer:it.word}));
  // if practicing wrong-book, try to load wrong entries for this unit
  if(mode==='wrong'){
    try{
      const wb = JSON.parse(localStorage.getItem('wrongBook')||'{}');
      const unitWrong = (wb && wb[unit])? wb[unit] : [];
      if(unitWrong.length>0){
        // build quiz from wrong entries, preserving type
        quiz = unitWrong.map((w,i)=>({id:w.id || (i+1), type:w.type, prompt:w.prompt, answer:w.correct || w.answer}));
        return;
      }
    }catch(e){ console.warn('wrongBook parse error',e); }
  }
  poolA = poolA.sort(()=>Math.random()-0.5);
  poolB = poolB.sort(()=>Math.random()-0.5);
  quiz = poolA.concat(poolB);
}));poolB=list.map((it,i)=>({id:(i+1)+'B',type:'B',prompt:it.definition,answer:it.word}));poolA=poolA.sort(()=>Math.random()-0.5);poolB=poolB.sort(()=>Math.random()-0.5);quiz=poolA.concat(poolB);}function start(){buildPools();pos=0;correct=0;timer=0;document.getElementById('start').classList.add('hidden');document.getElementById('end').classList.remove('hidden');tid=setInterval(()=>{timer++;updateStatus();},1000);showQuestion();}function endNow(){if(tid)clearInterval(tid);tid=null;saveResult();showResult();}function showQuestion(){if(pos>=quiz.length){endNow();return;}const q=quiz[pos];document.getElementById('meta').textContent='題型: '+(q.type==='A'?'英→中':'中→英')+' | 題數: '+(pos+1)+' / '+quiz.length+' | 時間: '+timer+'s';document.getElementById('qbox').textContent=(q.type==='A'?'英文：':'中文：')+q.prompt;const pool=(q.type==='A')?list.map(i=>i.definition):list.map(i=>i.word);let opts=pool.filter(o=>o!==q.answer).sort(()=>Math.random()-0.5).slice(0,3);opts.push(q.answer);opts.sort(()=>Math.random()-0.5);const choices=document.getElementById('choices');choices.innerHTML='';opts.forEach(o=>{const d=document.createElement('div');d.className='choice';d.textContent=o;d.onclick=()=>{if(o===q.answer){d.classList.add('correct');correct++;}else{d.classList.add('wrong');const ca=document.createElement('div');ca.className='correct-answer';ca.textContent='正確答案：'+q.answer;d.appendChild(ca);}pos++;setTimeout(showQuestion,700);};choices.appendChild(d);});updateStatus();}function updateStatus(){document.getElementById('status').textContent='進度：'+(pos+1)+' / '+(quiz.length)+'　|　時間：'+timer+' 秒';}function saveResult(){
  const accuracy = Math.round(correct/quiz.length*1000)/10;
  const score = Math.round(correct/quiz.length*100);
  const res = {unit:unit,total:quiz.length,correct:correct,time:timer,accuracy:accuracy,score:score,timestamp:Date.now()};
  saveLastResult(res);
  // save detailed answers
  localStorage.setItem('lastAnswers', JSON.stringify({unit:unit, answers: answers, timestamp: Date.now()}));
  // update wrongBook: collect wrong answers and append unique entries per unit
  try{
    const wb = JSON.parse(localStorage.getItem('wrongBook')||'{}');
    wb[unit] = wb[unit] || [];
    const wrongs = answers.filter(a=>!a.isCorrect).map(a=>({id:a.id, type:a.type, prompt:a.prompt, selected:a.selected, correct:a.correct}));
    // append new wrongs if not already present (by prompt+type)
    wrongs.forEach(w=>{
      const exists = wb[unit].some(x => x.prompt===w.prompt && x.type===w.type && x.correct===w.correct);
      if(!exists) wb[unit].push(w);
    });
    localStorage.setItem('wrongBook', JSON.stringify(wb));
  }catch(e){ console.warn('save wrongBook error', e); }
};
  saveLastResult(res);
  // save detailed answers
  localStorage.setItem('lastAnswers', JSON.stringify({unit:unit, answers: answers, timestamp: Date.now()}));
};saveLastResult(res);}function showResult(){
  const r = loadLastResult();
  const el = document.getElementById('result');
  el.innerHTML = '<div class="result"><h3>測驗完成</h3><p>作答時間：' + r.time + ' 秒</p><p>正確率：' + r.accuracy + '%</p><p>分數：' + r.score + ' 分</p><p style="margin-top:8px"><a href="result.html">查看詳細錯題/成績</a></p></div>';
  document.getElementById('start').classList.remove('hidden');
  document.getElementById('end').classList.add('hidden');
}
document.getElementById('start').onclick=start;document.getElementById('end').onclick=endNow;</script></body></html>